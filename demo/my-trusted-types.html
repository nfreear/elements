<!doctype html><html lang="en">

<meta
  http-equiv="Content-Security-Policy"
  content="require-trusted-types-for 'script'; trusted-types allowAnchor allowAnchorListPlus"
>

<link rel="stylesheet" href="style/app.v2.css">
<style>
  #myDiv {
    background: #eee;
    border: 1px solid silver;
    line-height: 1.8;
    margin: 2rem 0;
    padding: 1rem;
  }
</style>

<title>Trusted Types test</title>

<h1>Trusted Types test</h1>

<p>Uses a <tt>Content-Security-Policy</tt> header with <tt>require-trusted-types-for</tt>.
  And, uses the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Trusted_Types_API">Trusted Types API</a>
  to sanitize input HTML data.
</p>


<div id="myDiv">Loading Trusted Types polyfill...</div>


<script type="uncleanHTML">
  <img src=x onerror=alert(1)>
  <script>console.error("BAD")</scr+ipt>
  <object>BAD</object> ,
  <iframe src="#_Bad"></iframe> ,
  <applet>Bad</applet> ,
  <A href="Javascript:alert(2)">Javascript: dodgy link</A> ,
  <a href="#" onclick="alert(3)">Dodgy 2</a> ,
  <A href="#">Clean link</A> ,
  <a class="X">Non-link</a>.
</script>


<script type="importmap">
{
  "imports": {
    "MyTrustedTypes": "../src/util/MyTrustedTypes.js"
  }
}
</script>

<script type="module">
  import MyTrustedTypes from 'MyTrustedTypes';

  const elem = document.querySelector('#myDiv');
  const uncleanHTML = document.querySelector('script[ type = uncleanHTML ]').textContent;
  const myTrustedTypes = new MyTrustedTypes();

  /* myTrustedTypes.load().then((mttObj) => {
    console.debug('TT obj:', mttObj);

    const escaped = mttObj.createHTML('allowAnchor', uncleanHTML);

    console.log('Trusted HTML?', mttObj, escaped instanceof TrustedHTML, escaped.toString()); // true

    elem.innerHTML = escaped.toString();
  }); */

  (async () => {
    await myTrustedTypes.load();

    const escaped = myTrustedTypes.createHTML('allowAnchor', uncleanHTML);

    console.assert(escaped instanceof TrustedHTML, 'Expecting trustedHTML');
    console.log('Trusted HTML?', myTrustedTypes, escaped); // true

    // elem.innerHTML = 'Hello world!'; // "my-trusted-types.html:64 This document requires 'TrustedHTML' assignment."
    elem.innerHTML = escaped;
  })();
</script>

</html>
